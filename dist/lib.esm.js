import e,{createContext as r,useContext as t,useState as n,useRef as a,useMemo as o,useReducer as i,useEffect as s}from"react";import u from"zen-observable";function c(e){if(!e.name)throw new Error("The provided operation is missing a name property!");return e.name+JSON.stringify(e.variables)}function l({query:e,variables:r={}}){if("Document"===e.kind)return{name:e.definitions[0].name.value,type:e.definitions[0].operation,kind:e.kind,query:e,variables:r};if("String"===e.kind)return{name:e.name,type:e.type,kind:e.kind,query:e.query,variables:r};throw new TypeError("Unknown Query!")}function f({link:e,initialState:r,ssrMode:t=!1}){const n=function(e){const r=new Map(e);return{get:e=>{const t=c(e);return r.get(t)||null},set:(e,t)=>{const n=c(e);r.set(n,t)},extract:()=>[...r]}}(r),{execute:a}=e;return{execute:a,store:n,ssrMode:t,load:({query:r,variables:t})=>{const a=l({query:r,variables:t});return e.executePromise(a).then(e=>{e.data&&n.set(a,e.data)})},createOperation:l}}const y=(e,r)=>Object.keys(e).length===Object.keys(r).length&&Object.keys(e).every(t=>r.hasOwnProperty(t)&&e[t]===r[t]),d=r();function p(r){const{client:t}=r;return e.createElement(d.Provider,{value:t},r.children)}function b(){return t(d)}function m(e,r){switch(r.type){case"FETCH_INIT":return{...e,loading:r.payload,error:!1};case"FETCH_SUCCESS":return{...e,loading:!1,error:!1,data:r.payload};case"FETCH_FAILURE":return{...e,loading:!1,error:!0};default:throw new Error}}function v(e,r={variables:{}}){r.variables=r.variables||{};const t=b(),[u,c]=n(r.variables),l=a(null),[f,d]=n(r.variables);y(r.variables,f)||(c(r.variables),d(r.variables));const p=o(()=>t.createOperation({query:e,variables:u}),[e,u]),v=t.store.get(p),h=!!v,[g,E]=i(m,{data:v,loading:!v,error:!1});return s(()=>{const e="function"==typeof l.current;if(!h){E({type:"FETCH_INIT",payload:!e});const r=t.execute(p).subscribe({next:r=>{t.store.set(p,r.data);const n=e?l.current(g.data,{fetchMoreResult:r.data}):r.data;l.current=null,E({type:"FETCH_SUCCESS",payload:n})},error:e=>{E({type:"FETCH_FAILURE"})}});return function(){r.unsubscribe()}}},[t,p,h]),{...g,refetch:c,variables:u,fetchMore:({variables:e,updateQuery:r})=>{c(e),l.current=r}}}function h(e,...r){let t=e[0];for(let r=1;r<e.length;r++)if(null===e[r].match(/^\s+$/))throw new Error("Expected Whitespace!");const{type:n,name:a}=function(e){const[r,t,n]=e.split(/^\s*(fragment|query|mutation) (\w*)( |\()/g);return{type:t,name:n}}(t);if("fragment"===n)return[t,r];const o=new Set(function e([r,...t]){return void 0===r?[]:Array.isArray(r)?[...e(r),...e(t)]:[r,...e(t)]}(r));return{type:n,name:a,query:t+" "+Array.from(o).join(" "),kind:"String"}}function g(e,r){return async function(e,r){return r.headers["Content-Type"]="application/json",(await fetch(e,r)).json()}(e.uri,{method:"POST",...e.fetchOptions,headers:e.headers,body:JSON.stringify({variables:r.variables,query:r.query,operationName:r.name})})}function E(e){return{execute:function(e){return r=>new u(t=>(g(e,r).then(e=>{t.next(e),t.complete()}),()=>{}))}(e)}}function w(r,t={}){return n=>a=>{const o=b(),i={ssr:!0,variables:{}},s="function"==typeof t.options?{...i,...t.options(a)}:{...i,...t.options||{}};if("mutation"===o.createOperation({query:r}).type)return e.createElement(n,{...a,mutate:()=>{}});if(o.ssrMode&&!s.ssr)return null;const{data:u,loading:c,error:l,refetch:f}=v(r,s);return e.createElement(n,{...a,data:{loading:c,error:l,refetch:f,...u||{}}})}}function q(){}function S(r){const t={query:async()=>{throw new Error("Fail!")}};return r=>e.createElement({...r,client:t})}function k({query:e,variables:r,children:t}){return t(v(e,{variables:r}))}export{p as ArtemisProvider,k as Query,q as compose,f as createClient,E as executor,h as gql,w as graphql,v as useQuery,S as withApollo};
