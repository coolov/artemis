import e,{createContext as r,useContext as t,useState as n,useRef as a,useMemo as o,useReducer as i,useEffect as s}from"react";import u from"zen-observable";function c(e){if(!e.name)throw new Error("The provided operation is missing a name property!");return e.name+JSON.stringify(e.variables)}function l({link:e,initialState:r,ssrMode:t=!1}){const n=function(e){const r=new Map(e);return{get:e=>{const t=c(e);return r.get(t)||null},set:(e,t)=>{const n=c(e);r.set(n,t)},extract:()=>[...r]}}(r),{execute:a}=e;return{execute:a,store:n,ssrMode:t,load:r=>e.executePromise(r).then(e=>{e.data&&n.set(r,e.data)}),createOperation({query:e,variables:r={}}){if("Document"===e.kind)return{name:e.definitions[0].name.value,type:e.definitions[0].operation,kind:e.kind,query:e,variables:r};if("String"===e.kind)return{name:e.name,type:e.type,kind:e.kind,query:e.query,variables:r};throw new TypeError("Unknown Query!")}}}const f=(e,r)=>Object.keys(e).length===Object.keys(r).length&&Object.keys(e).every(t=>r.hasOwnProperty(t)&&e[t]===r[t]),d=r();function y(r){const{client:t}=r;return e.createElement(d.Provider,{value:t},r.children)}function p(){return t(d)}function b(e,r){switch(r.type){case"FETCH_INIT":return{...e,loading:r.payload,error:!1};case"FETCH_SUCCESS":return{...e,loading:!1,error:!1,data:r.payload};case"FETCH_FAILURE":return{...e,loading:!1,error:!0};default:throw new Error}}function m(e,r={variables:{}}){r.variables=r.variables||{};const t=p(),[u,c]=n(r.variables),l=a(null),[d,y]=n(r.variables);f(r.variables,d)||(c(r.variables),y(r.variables));const m=o(()=>t.createOperation({query:e,variables:u}),[e,u]),v=t.store.get(m),h=!!v,[g,E]=i(b,{data:v,loading:!v,error:!1});return s(()=>{const e="function"==typeof l.current;if(!h){E({type:"FETCH_INIT",payload:!e});const r=t.execute(m).subscribe({next:r=>{t.store.set(m,r.data);const n=e?l.current(g.data,{fetchMoreResult:r.data}):r.data;l.current=null,E({type:"FETCH_SUCCESS",payload:n})},error:e=>{E({type:"FETCH_FAILURE"})}});return function(){r.unsubscribe()}}},[t,m,h]),{...g,refetch:c,variables:u,fetchMore:({variables:e,updateQuery:r})=>{c(e),l.current=r}}}function v(...e){const r=function(e){for(var r=[e[0]],t=1,n=arguments.length;t<n;t++)r.push(arguments[t],e[t]);return r.join("")}(...e),{type:t,name:n}=function(e){const[r,t,n]=e.split(/^\s*(fragment|query|mutation) (\w*)( |\()/g);return{type:t,name:n}}(r);return"fragment"===t?r:{type:t,name:n,query:r,kind:"String"}}function h(e,r){return async function(e,r){return r.headers["Content-Type"]="application/json",(await fetch(e,r)).json()}(e.uri,{method:"POST",...e.fetchOptions,headers:e.headers,body:JSON.stringify({variables:r.variables,query:r.query,operationName:r.name})})}function g(e){return{execute:function(e){return r=>new u(t=>(h(e,r).then(e=>{t.next(e),t.complete()}),()=>{}))}(e)}}function E(r,t={}){return n=>a=>{const o=p(),i={ssr:!0,variables:{}},s="function"==typeof t.options?{...i,...t.options(a)}:{...i,...t.options||{}};if("mutation"===o.createOperation({query:r}).type)return e.createElement(n,{...a,mutate:()=>{}});if(o.ssrMode&&!s.ssr)return null;const{data:u,loading:c,error:l,refetch:f}=m(r,s);return e.createElement(n,{...a,data:{loading:c,error:l,refetch:f,...u||{}}})}}function w(){}function k(r){const t={query:async()=>{throw new Error("Fail!")}};return r=>e.createElement({...r,client:t})}function q({query:e,variables:r,children:t}){return t(m(e,{variables:r}))}export{y as ArtemisProvider,q as Query,w as compose,l as createClient,g as executor,v as gql,E as graphql,m as useQuery,k as withApollo};
